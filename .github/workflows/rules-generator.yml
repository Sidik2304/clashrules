#=================================================
# Description: Generate Rule Provider for Clash
# Script by helmiau.com
# https://github.com/blackmatrix7/ios_rule_script/tree/master/rule/Clash/'
# Run setiap 2 jam sekali
# curl -sL https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/README.md | grep "blackmatrix7/ios_rule_script/tree/master/rule/Clash" | sed -e 's/ //g' -e 's/|/\n/g' -e 's#https://github.com/blackmatrix7/ios_rule_script/tree/master/rule/Clash/#rule_name: #iIg' -e 's#(#bukaan#g' -e 's#)##g' | sed '/^[[:space:]]*$/d' | sed 's/^.*\(rule_name.*\).*$/\1/' | sed 's#rule_name#          - rule_name#g' > include-rule.yaml
# Run setiap 2 jam sekali
#=================================================

name: Clash Rule Generator

on:
  workflow_dispatch:
  schedule:
    - cron: 0 */2 * * *
#  watch:
#    types: started

jobs:
  release:
    name: Generate ${{ matrix.rule_name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - rule_name: Advertising
          - rule_name: AdvertisingLite
          - rule_name: AdvertisingMiTV
          - rule_name: AdvertisingTest
          - rule_name: WhiteList
          - rule_name: ZhihuAds
          - rule_name: AppStore
          - rule_name: Apple
          - rule_name: AppleMail
          - rule_name: AppleMusic
          - rule_name: AppleNews
          - rule_name: AppleProxy
          - rule_name: AppleTV
          - rule_name: FindMy
          - rule_name: FitnessPlus
          - rule_name: Siri
          - rule_name: SystemOTA
          - rule_name: TestFlight
          - rule_name: iCloud
          - rule_name: Battle
          - rule_name: Blizzard
          - rule_name: Classic
          - rule_name: DiabloIII
          - rule_name: EA
          - rule_name: Epic
          - rule_name: Game
          - rule_name: Garena
          - rule_name: Gog
          - rule_name: Hearthstone
          - rule_name: HeroesoftheStorm
          - rule_name: Nintendo
          - rule_name: OP
          - rule_name: Origin
          - rule_name: Overwatch
          - rule_name: PlayStation
          - rule_name: Purikonejp
          - rule_name: Riot
          - rule_name: Rockstar
          - rule_name: Sony
          - rule_name: StarCraftII
          - rule_name: Steam
          - rule_name: SteamCN
          - rule_name: Supercell
          - rule_name: UBI
          - rule_name: WildRift
          - rule_name: WorldofWarcraft
          - rule_name: Xbox
          - rule_name: 9News
          - rule_name: 9to5
          - rule_name: AFP
          - rule_name: AOL
          - rule_name: ATTWatchTV
          - rule_name: AbemaTV
          - rule_name: Acer
          - rule_name: Adidas
          - rule_name: Adobe
          - rule_name: Akamai
          - rule_name: All4
          - rule_name: Amazon
          - rule_name: AmazonPrimeVideo
          - rule_name: Americasvoice
          - rule_name: Apkpure
          - rule_name: AppStore
          - rule_name: Apple
          - rule_name: AppleDaily
          - rule_name: AppleMail
          - rule_name: AppleMusic
          - rule_name: AppleNews
          - rule_name: AppleProxy
          - rule_name: AppleTV
          - rule_name: AsianMedia
          - rule_name: Atlassian
          - rule_name: BBC
          - rule_name: BMW
          - rule_name: Bahamut
          - rule_name: Bestbuy
          - rule_name: BlackList
          - rule_name: Bloomberg
          - rule_name: Blued
          - rule_name: BoXun
          - rule_name: BrightCove
          - rule_name: Buypass
          - rule_name: CBS
          - rule_name: CHT
          - rule_name: CNBC
          - rule_name: CNN
          - rule_name: CableTV
          - rule_name: Canon
          - rule_name: Cisco
          - rule_name: Cloudflare
          - rule_name: Clubhouse
          - rule_name: ClubhouseIP
          - rule_name: Comodo
          - rule_name: Cryptocurrency
          - rule_name: DAZN
          - rule_name: Dailymail
          - rule_name: Dailymotion
          - rule_name: Deezer
          - rule_name: Dell
          - rule_name: DigiCert
          - rule_name: Discord
          - rule_name: Disney
          - rule_name: Disqus
          - rule_name: Docker
          - rule_name: Dood
          - rule_name: Dropbox
          - rule_name: DtDNS
          - rule_name: Dubox
          - rule_name: Duckduckgo
          - rule_name: DynDNS
          - rule_name: Dynu
          - rule_name: Embl
          - rule_name: Emojipedia
          - rule_name: EncoreTVB
          - rule_name: Espn
          - rule_name: Facebook
          - rule_name: FitnessPlus
          - rule_name: FlipBoard
          - rule_name: Fox
          - rule_name: Gettyimages
          - rule_name: Gigabyte
          - rule_name: GitBook
          - rule_name: GitHub
          - rule_name: GitLab
          - rule_name: Global
          - rule_name: GlobalMedia
          - rule_name: Globalsign
          - rule_name: Google
          - rule_name: GoogleDrive
          - rule_name: Gucci
          - rule_name: HBO
          - rule_name: HKBN
          - rule_name: HKedcity
          - rule_name: HP
          - rule_name: HWTV
          - rule_name: HashiCorp
          - rule_name: Heroku
          - rule_name: Huffpost
          - rule_name: Hulu
          - rule_name: IBM
          - rule_name: IMDB
          - rule_name: ITV
          - rule_name: Identrust
          - rule_name: Imgur
          - rule_name: Instagram
          - rule_name: Intel
          - rule_name: Intercom
          - rule_name: JOOX
          - rule_name: Japonx
          - rule_name: Jetbrains
          - rule_name: Jfrog
          - rule_name: Jquery
          - rule_name: Jsdelivr
          - rule_name: Jwplayer
          - rule_name: KKBOX
          - rule_name: KakaoTalk
          - rule_name: Kantv
          - rule_name: LG
          - rule_name: LastFM
          - rule_name: LastPass
          - rule_name: LiTV
          - rule_name: Limelight
          - rule_name: Line
          - rule_name: LineTV
          - rule_name: LivePerson
          - rule_name: Logitech
          - rule_name: LondonReal
          - rule_name: MEGA
          - rule_name: MOMOShop
          - rule_name: MOOV
          - rule_name: Mail
          - rule_name: Mailru
          - rule_name: Manorama
          - rule_name: McDonalds
          - rule_name: MeWatch
          - rule_name: Microsoft
          - rule_name: Mozilla
          - rule_name: My5
          - rule_name: NYPost
          - rule_name: NYTimes
          - rule_name: Naver
          - rule_name: Netflix
          - rule_name: Nike
          - rule_name: Nikkei
          - rule_name: Notion
          - rule_name: Nvidia
          - rule_name: OneDrive
          - rule_name: Opera
          - rule_name: Oreilly
          - rule_name: PBS
          - rule_name: PCCW
          - rule_name: PChomeTW
          - rule_name: Pandora
          - rule_name: PandoraTV
          - rule_name: PayPal
          - rule_name: Picsee
          - rule_name: Pinterest
          - rule_name: Pixiv
          - rule_name: Pixnet
          - rule_name: PotatoChat
          - rule_name: PrivateTracker
          - rule_name: Protonmail
          - rule_name: Proxy
          - rule_name: Python
          - rule_name: Qobuz
          - rule_name: Qualcomm
          - rule_name: RTHK
          - rule_name: Rakuten
          - rule_name: Rarbg
          - rule_name: Razer
          - rule_name: Reddit
          - rule_name: Samsung
          - rule_name: Scaleflex
          - rule_name: Scholar
          - rule_name: Sectigo
          - rule_name: Shopee
          - rule_name: Shopify
          - rule_name: Siri
          - rule_name: SkyGO
          - rule_name: Slack
          - rule_name: Sling
          - rule_name: SmarTone
          - rule_name: Snap
          - rule_name: Sony
          - rule_name: SoundCloud
          - rule_name: SourceForge
          - rule_name: Spark
          - rule_name: Speedtest
          - rule_name: Spotify
          - rule_name: Stackexchange
          - rule_name: Starbucks
          - rule_name: SublimeText
          - rule_name: Synology
          - rule_name: TIDAL
          - rule_name: TVB
          - rule_name: TaiWanGood
          - rule_name: TeamViewer
          - rule_name: Telegram
          - rule_name: TelegramNL
          - rule_name: TelegramSG
          - rule_name: TelegramUS
          - rule_name: Tesla
          - rule_name: TestFlight
          - rule_name: ThomsonReuters
          - rule_name: TikTok
          - rule_name: Tumblr
          - rule_name: Twitch
          - rule_name: Twitter
          - rule_name: Unity
          - rule_name: VISA
          - rule_name: VK
          - rule_name: VOA
          - rule_name: Vercel
          - rule_name: Verisign
          - rule_name: Verizon
          - rule_name: VidolTV
          - rule_name: Viki
          - rule_name: Vimeo
          - rule_name: ViuTV
          - rule_name: Voxmedia
          - rule_name: WIX
          - rule_name: WeTV
          - rule_name: Westerndigital
          - rule_name: Whatsapp
          - rule_name: Wikimedia
          - rule_name: Wikipedia
          - rule_name: Wordpress
          - rule_name: Yandex
          - rule_name: YouTube
          - rule_name: YouTubeMusic
          - rule_name: Zee
          - rule_name: ZeeTV
          - rule_name: Zendesk
          - rule_name: Zoho
          - rule_name: eBay
          - rule_name: friDay
          - rule_name: iCloud
          - rule_name: iTalkBB
          - rule_name: AppleMusic
          - rule_name: AppleTV
          - rule_name: AsianMedia
          - rule_name: BBC
          - rule_name: Bahamut
          - rule_name: DiscoveryPlus
          - rule_name: Disney
          - rule_name: FOXNOW
          - rule_name: FOXPlus
          - rule_name: GlobalMedia
          - rule_name: HBOAsia
          - rule_name: HBOHK
          - rule_name: HBOUSA
          - rule_name: HuluJP
          - rule_name: HuluUSA
          - rule_name: KKTV
          - rule_name: NaverTV
          - rule_name: Netflix
          - rule_name: Niconico
          - rule_name: NowE
          - rule_name: Overcast
          - rule_name: PandoraTV
          - rule_name: ParamountPlus
          - rule_name: Peacock
          - rule_name: PrimeVideo
          - rule_name: Spotify
          - rule_name: TVer
          - rule_name: TikTok
          - rule_name: YouTube
          - rule_name: YouTubeMusic
          - rule_name: bilibiliIntl
          - rule_name: myTVSUPER
          - rule_name: Chromecast
          - rule_name: Google
          - rule_name: GoogleDrive
          - rule_name: GoogleSearch
          - rule_name: GoogleVoice
          - rule_name: YouTubeMusic
          - rule_name: 115
          - rule_name: 12306
          - rule_name: 17173
          - rule_name: 178
          - rule_name: 17zuoye
          - rule_name: 360
          - rule_name: 36kr
          - rule_name: 4399
          - rule_name: 51Job
          - rule_name: 56
          - rule_name: 58TongCheng
          - rule_name: 6JianFang
          - rule_name: 8btc
          - rule_name: ABC
          - rule_name: AcFun
          - rule_name: Agora
          - rule_name: AliPay
          - rule_name: Alibaba
          - rule_name: AnTianKeJi
          - rule_name: Anjuke
          - rule_name: BOC
          - rule_name: BOCOM
          - rule_name: BaiFenDian
          - rule_name: BaiShanYunKeJi
          - rule_name: Baidu
          - rule_name: BaoFengYingYin
          - rule_name: BianFeng
          - rule_name: BiliBili
          - rule_name: Bootcss
          - rule_name: ByteDance
          - rule_name: CAS
          - rule_name: CCB
          - rule_name: CCTV
          - rule_name: CEB
          - rule_name: CGB
          - rule_name: CIBN
          - rule_name: CITIC
          - rule_name: CKJR
          - rule_name: CMB
          - rule_name: CNKI
          - rule_name: CNNIC
          - rule_name: CSDN
          - rule_name: CaiNiao
          - rule_name: CaiXinChuanMei
          - rule_name: Camera360
          - rule_name: ChengTongWangPan
          - rule_name: China
          - rule_name: ChinaIPs
          - rule_name: ChinaIPsBGP
          - rule_name: ChinaMedia
          - rule_name: ChinaMobile
          - rule_name: ChinaNews
          - rule_name: ChinaTelecom
          - rule_name: ChinaTest
          - rule_name: ChinaUnicom
          - rule_name: ChuangKeTie
          - rule_name: ChunYou
          - rule_name: DaMai
          - rule_name: DanDanZan
          - rule_name: Dandanplay
          - rule_name: DangDang
          - rule_name: Dedao
          - rule_name: Deepin
          - rule_name: DiDi
          - rule_name: DiLianWangLuo
          - rule_name: DiSiFanShi
          - rule_name: DianCeWangKe
          - rule_name: DingTalk
          - rule_name: DingXiangYuan
          - rule_name: Domob
          - rule_name: DouBan
          - rule_name: Douyu
          - rule_name: EastMoney
          - rule_name: Eleme
          - rule_name: FanFou
          - rule_name: FeiZhu
          - rule_name: FengHuangWang
          - rule_name: FengXiaWangLuo
          - rule_name: Fiio
          - rule_name: Funshion
          - rule_name: GaoDe
          - rule_name: GuiGuDongLi
          - rule_name: HaiNanHangKong
          - rule_name: HanYi
          - rule_name: HeMa
          - rule_name: HibyMusic
          - rule_name: Himalaya
          - rule_name: Hpplay
          - rule_name: HuYa
          - rule_name: HuaShuTV
          - rule_name: HuanJu
          - rule_name: Huawei
          - rule_name: HunanTV
          - rule_name: Hupu
          - rule_name: ICBC
          - rule_name: JiGuangTuiSong
          - rule_name: JianGuoYun
          - rule_name: JianShu
          - rule_name: JinJiangWenXue
          - rule_name: JingDong
          - rule_name: JueJin
          - rule_name: Keep
          - rule_name: KingSmith
          - rule_name: Kingsoft
          - rule_name: KouDaiShiShang
          - rule_name: Ku6
          - rule_name: KuKeMusic
          - rule_name: KuaiDi100
          - rule_name: KuaiShou
          - rule_name: KuangShi
          - rule_name: KugouKuwo
          - rule_name: LanZouYun
          - rule_name: LeJu
          - rule_name: LeTV
          - rule_name: Lenovo
          - rule_name: LianMeng
          - rule_name: LuDaShi
          - rule_name: LvMiLianChuang
          - rule_name: Maocloud
          - rule_name: MeiTuan
          - rule_name: MeiZu
          - rule_name: Meitu
          - rule_name: MiWu
          - rule_name: Migu
          - rule_name: MingLueZhaoHui
          - rule_name: Mogujie
          - rule_name: Mojitianqi
          - rule_name: NGAA
          - rule_name: NetEase
          - rule_name: NetEaseMusic
          - rule_name: OPPO
          - rule_name: OnePlus
          - rule_name: OuPeng
          - rule_name: PPTV
          - rule_name: PSBC
          - rule_name: Pinduoduo
          - rule_name: PingAn
          - rule_name: QiNiuYun
          - rule_name: QingCloud
          - rule_name: RuanMei
          - rule_name: SFExpress
          - rule_name: SMZDM
          - rule_name: ShangHaiJuXiao
          - rule_name: Shanling
          - rule_name: ShenMa
          - rule_name: ShiNongZhiKe
          - rule_name: Sina
          - rule_name: Sohu
          - rule_name: SouFang
          - rule_name: SuNing
          - rule_name: SuiShiChuanMei
          - rule_name: TCL
          - rule_name: TaiKang
          - rule_name: TaiheMusic
          - rule_name: Teambition
          - rule_name: TencentVideo
          - rule_name: TianTianKanKan
          - rule_name: TianWeiChengXin
          - rule_name: TianYaForum
          - rule_name: TigerFintech
          - rule_name: TongCheng
          - rule_name: U17
          - rule_name: UC
          - rule_name: UCloud
          - rule_name: UPYun
          - rule_name: UnionPay
          - rule_name: Vancl
          - rule_name: VipShop
          - rule_name: Vivo
          - rule_name: WanMeiShiJie
          - rule_name: WangSuKeJi
          - rule_name: WangXinKeJi
          - rule_name: WeiZhiYunDong
          - rule_name: Weibo
          - rule_name: WenJuanXing
          - rule_name: WiFiMaster
          - rule_name: XiamiMusic
          - rule_name: XianYu
          - rule_name: XiaoGouKeJi
          - rule_name: XiaoMi
          - rule_name: XiaoYuanKeJi
          - rule_name: XieCheng
          - rule_name: XueErSi
          - rule_name: XueQiu
          - rule_name: Xunlei
          - rule_name: YYeTs
          - rule_name: YiChe
          - rule_name: YiXiaKeJi
          - rule_name: YiZhiBo
          - rule_name: YouMengChuangXiang
          - rule_name: YouZan
          - rule_name: Youku
          - rule_name: YuanFuDao
          - rule_name: YunFanJiaSu
          - rule_name: ZDNS
          - rule_name: ZhangYue
          - rule_name: ZhiYunZhong
          - rule_name: ZhongGuoShiHua
          - rule_name: ZhongWeiShiJi
          - rule_name: ZhongYuanYiShang
          - rule_name: ZhuanZhuan
          - rule_name: iFlytek
          - rule_name: iQIYI
          - rule_name: ifanr
          - rule_name: BiliBili
          - rule_name: CCTV
          - rule_name: ChinaMedia
          - rule_name: Douyu
          - rule_name: Himalaya
          - rule_name: NetEaseMusic
          - rule_name: TencentVideo
          - rule_name: Youku
          - rule_name: iQIYI
          - rule_name: AppleMusic
          - rule_name: AppleTV
          - rule_name: AsianMedia
          - rule_name: BBC
          - rule_name: Bahamut
          - rule_name: BiliBili
          - rule_name: CCTV
          - rule_name: ChinaMedia
          - rule_name: GlobalMedia
          - rule_name: HBOHK
          - rule_name: HBOUSA
          - rule_name: Himalaya
          - rule_name: HuluJP
          - rule_name: HuluUSA
          - rule_name: NetEaseMusic
          - rule_name: Spotify
          - rule_name: Tencent
          - rule_name: TencentVideo
          - rule_name: YouTube
          - rule_name: YouTubeMusic
          - rule_name: iQIYI
          - rule_name: GitHub
          - rule_name: Microsoft
          - rule_name: OneDrive
          - rule_name: Developer
          - rule_name: Download
          - rule_name: Lan
          - rule_name: PrivateTracker
          - rule_name: Advertising
          - rule_name: AdvertisingLite
          - rule_name: AdvertisingTest
          - rule_name: Hijacking
          - rule_name: Privacy
          - rule_name: ZhihuAds
          - rule_name: All_In_One

    env:
      RULENAME: ${{ matrix.rule_name }}
      RULENAME_RESOLVE: ${{ matrix.rule_name }}_Resolve
      BMSRC: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/${{ matrix.rule_name }}/${{ matrix.rule_name }}.yaml
      BMSRC_RESOLVE: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/${{ matrix.rule_name }}/${{ matrix.rule_name }}_Resolve.yaml
 
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Generate ${{ matrix.rule_name }} rule file
        run: |
          if [[ $RULENAME = "All_In_One" ]]; then
            echo -e "Waiting 20 secs before creating $RULENAME rule..."
            sleep 20
            echo -e "Downloading required rules for $RULENAME.yaml"
            mkdir -p "allsource"
            wget --no-check-certificate $(curl -L https://github.com/helmiau/clashrules/releases/tag/clashrules-$(date +%Y.%m.%d) | grep "/helmiau/clashrules/releases/download" | grep "yaml" | sed -e 's/\"//g' -e 's/ //g' -e 's/rel=.*//g' -e 's#<ahref=#http://github.com#g') -P allsource
            echo "---- List source files :"
            find allsource rule_provider -type f -name '*.yaml'
            echo "---- End of List source files :"
            echo -e "# ${RULENAME}\npayload:\n" > "$RULENAME.yaml";
            find allsource rule_provider -type f -name '*.yaml' | while read -r FILE ; do
                echo -e $(readlink -f ${FILE});
                sed -i "/^#/d" "${FILE}";
                namafile=$(echo -e "$FILE" | sed -e 's/ /_/g' | cut -f 1 -d '.');
                sed -i 's|payload:|# > '"$namafile"'|g' "${FILE}";
                cat "${FILE}" >> "$RULENAME.yaml";
                rm -f ${FILE};
            done
            echo -e "$RULENAME.yaml Created..."
          else
            # BMSRC : blackmatrix7/ios_rule_script default yaml
            if wget -S --spider $BMSRC 2>&1 | grep -q 'HTTP/1.1 200 OK'; then
                echo -e "Downloading $RULENAME.yaml"
                curl -L $BMSRC > "$RULENAME.txt"
                sed -i "/^#/d" "$RULENAME.txt"
                echo -e "# ${RULENAME}" > "$RULENAME.yaml";
                cat "$RULENAME.txt" >> "$RULENAME.yaml";
                echo -e "" >> "$RULENAME.yaml";
                echo -e "" >> "$RULENAME.yaml";
            fi
            # BMSRC_RESOLVE = blackmatrix7/ios_rule_script resolve script
            if wget -S --spider $BMSRC_RESOLVE 2>&1 | grep -q 'HTTP/1.1 200 OK'; then
                echo -e "Downloading $RULENAME_RESOLVE.yaml"
                curl -L $BMSRC_RESOLVE > "$RULENAME_RESOLVE.txt"
                sed -i "/^#/d" "$RULENAME_RESOLVE.txt"
                echo -e "# ${RULENAME_RESOLVE}" > "$RULENAME_RESOLVE.yaml";
                cat "$RULENAME_RESOLVE.txt" >> "$RULENAME_RESOLVE.yaml";
                echo -e "" >> "$RULENAME_RESOLVE.yaml";
                echo -e "" >> "$RULENAME_RESOLVE.yaml";
            fi
          fi
          echo -e "------- Listing YAML files"
          ls | grep "yaml"
          echo -e "------- End of Listing YAML files"
          echo "RELEASE_NAME=HelmiClash $(date +%Y.%m.%d)" >> $GITHUB_ENV
          echo "TAG_NAME=clashrules-$(date +%Y.%m.%d)" >> $GITHUB_ENV

      - name: Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.RELEASE_NAME }}
          tag_name: ${{ env.TAG_NAME }}
          draft: false
          prerelease: false
          files: "*.yaml"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Delete Workflow Runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 3
